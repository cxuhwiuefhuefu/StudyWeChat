# StudyWeChat
公众号学习笔记

https://www.bilibili.com/video/BV1ki4y1b7Hj?p=2


服务号和订阅号 开发差不多的 

```js                                   
微信用户1            微信公众号          自己的服务器     Java\PHP  
微信用户2           （微信服务器）        （微商城）      Python\NodeJs
微信用户3                                               
                                                       数据库
                                                       MySQL/MonoDB

                                                       微商城的界面
                                                       （通过布局写好部署到我们的服务器上去 只有就可以被用户访问到了）
                                                       
```

##### 当微信用户请求我们公众平台的时候 可以通过对接的方式 进一步引导到我们自己的服务器上去  比如我们要放一个网页 微信服务上肯定不会让我们放网页的 但我们可以在自己的服务器上放一个微商城 那用户通过我这个微信公众号平台去期望访问的时候 其实微信平台就会把用户的请求引导到或者转发到我们自己的服务器上去 然后获取对应内容之后下发下来 存储所有内容都是在自己服务器上完成的  微信只作为一个中介让我们跟用户进行沟通  之所以依托于微信平台就是因为用户的群体比较大 你在这个上面开发一些产品之后 它其实比较容易对用户触达到的 

在服务器上需要使用一门语言进行服务端逻辑的开发 这个服务端语言可以是Java/PHP/Python 我们选的是nodeJS nodeJS对我们前端比较友好 还需要一个数据库 因为作为微商城只有页面 里面不存任何商品不存任何数据 用户只能看不能点  数据（MySQL丶MongoDB）

就是一点 在微信公众号转发到我自己的服务器上去 自己服务器收到消息就按需求提取微商城的界面下发下去 微信用户就拿到 这个界面就会向这个数据库发起查询操作 把数据库一起携带下去

使用`postMan
post`请求
放在`body`的`x-www-form-urlencoded`下面


这就是从`前端 ==》后端 ==》 数据库`的流程




## express框架搭建服务端项目


如何使用新浪云SAE将我们本地服务部署到远程服务器

新浪云SAE
是以容器的形式为我们提供部署我们自己服务程序的容器


二级域名 需要通过通过服务器跟我们微信服务器进行鉴权的时候它需要一个真实备案的真实域名 这样的服务器才能够跟我们的微信服务器进行关联

二级域名自定义

只需要将本地开发的代码通过git的方式发布到我们这个容器里面

部署的时候
node_modules是不需要去拷贝的  因为我们容器在部署过程当中 它会自动帮我们去安装依赖 不需要提交第三方的依赖包

Git提交之后 只需要等服务端为我们构建部署项目就行了 

如果想微信服务器和我们的服务器进行沟通的话 微信官方要求我们整个我们自己服务器进行一个鉴权操作 所谓的鉴权操作就是让微信官方知道这个服务器确实是你允许的 是你真实存在的一个服务器 是一个合法的服务器并且在这种情况下我们微信平台才能允许我们在这台服务器上去获取一些微信官方所提供的能力 然后进行我们项目后续的开发 我们将这个过程称之`服务器鉴权` 也就是微信服务器和我们之间的服务器需要一个鉴权的过程



## JS-SDK鉴权流程
之所以要进行微信鉴权 是因为微信在开发模式下为我们提供大量的平台上所拥有的能力  


index.html
使用JS-sdk

引入JS-SDK
JSweixin.js



JS-SDK本身就是一个JS文件 封装了很多方法 我们可以在微信的环境下通过这个方法调用对应的功能

单纯引入还不够  还需要`wx.config`方法对我们整个权限进行验证 只有验证通过之后 这个微信服务器才认为你是一个有权利调用的人

引入JS需要一个初始化配置 初始化配置成功之后 wx.ready成功成功 进入ready方法说明我们已经鉴权成功 在这里我们调用JS-SDK里面的API

wx.config里面注入参数 由这些参数来分辨是否合法用户  
生成签名的时间戳和生成签名的随机串需要我们通过一段代码去生成一下

jsApiList：当你鉴权成功之后 你想要在你的网页里面使用那些功能 你需要把对应的一些方法名字列在这里 对于列在列表里面的方法验证成功之后才能够去使用

`时间戳`丶`随机字符串`丶`签名`是随机处理 其他是可以从平台直接获取 直接填写 这三项我们在服务端生成 因为签名过程中我们服务端也是需要使用到这些信息 好跟微信服务器进行一个互相验证的操作

期望新浪云服务Node服务下到我们所需要这些参数 那这些参数让前端通过一个请求拿到之后 配置到我的这个wx.config里面之后 只要这部分操作合理 必然会鉴权通过 就可以使用里面这些方法了 时间戳和随机字符串都好生成  签名这个生成流程比较麻烦

现有`access_token`再有`jsapi_ticket`

URL: 那个网页想用这些方法 就用哪个网页拿这些链接给我生成 url需要在前端去获取 需要在前端去发起请求想要拿这些信息的时候把这些数据带到我们这个服务器上去 这些是前端带给我们的 

`jsapi_ticket`是从微信服务器上拿的  `timestamp`和`nonceStr`是代码生成的 url是前端请求这些信息的时候为我们提交上来的 



## 公众号JS安全域名设置


# JS-SDK鉴权流程
## 步骤一：绑定域名
#### 1.微信公众号进入`公众号设置`中`功能设置`里填写`JS接口安全域名`
> 需要事先下载一个MP_....txt文件，放在我们自己填写的域名的静态资源文件夹下去

> 保证我们可以通过域名路径+MP_....txt的方式可以访问到该文件，已做验证

> 例如：我们想要配置aifoose.applinzi.com域名

> 则我们要保证通过http://aifoose.applinzi.com/MP_....txt 可以访问到服务器上的这个文件


#### 2. IP白名单配置
> 微信公众号进入“安全中心”的IP白名单"里填写，跟JS-SDK鉴权相关的所有IP

> 新浪云相关IP的位置：文档中心 --- 入口和出口IP --- 外网访问出口 IP 列表

如果想在自己的域名下面进行一些功能开发 并且还要在公众号平台里面生效 首先需要将你自己的域名跟我们的微信公众平台进行绑定/关联

把验证文件放在`public`下面去 直接git上传上去 这个部署过程因为它需要一些第三方依赖包的一些下载等操作 它需要耗费一些时间

为保证微信公众平台跟新浪云能够进行流畅的沟通  我们需要将新浪云 它IP列表里面`所有的IP`都配置到我们这个微信公众号平台`安全中心`的`IP白名单`

新浪云 `入口和出口IP` 拷贝配置到`公众号的安全中心`里面去

这样子 新浪云服务器和微信服务器可以`进行沟通`了 
然后再沟通过程中需要做一些`权限上面的验证`

必须引入JS-SDK才能使用这些功能

通过请求和后端处理 然后得到 再进行验证 这些配置项通过服务端帮我们下发下来 所以在本页面向远端服务器的某个接口发起请求



## 公众号服务器接入

服务器配置 启动

当我们用户点击提交向接口发起请求的时候 我们在接口的时候要做一些验证 然后通过验证之后进行一些交流 下一步在后端一些小接口

微信发消息带这样四个信息到你这个接口上去